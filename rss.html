<html>
  <head>
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  </head>
  <body>    
    <div id="rss-agg-table"></div>
    <script type='text/javascript'>      
      const NAME_RE = /(?<site>[A-Za-z0-9_-]+)\W(?<episode>[Ee]\d+|(?<year>\d{2,4})(?:\W(?<month>\d{2})\W(?<day>\d{2}))?)\W(?<title>.+)\WXXX/;
      let sceneEvals = [
        ["1080p", "HEVC"],
        ["720p", "HEVC"],
        ["1080p"],
        ["720p"],
      ];
      function newsnabAjaxResponse(url, params, response) {
        return {"last_page": 3, "data": response.channel.item.map((jsonItem) => {
          let score = sceneEvals.findIndex(e => e.every(t => jsonItem.title.includes(t)));
          if (score < 0) score = 100;
          let item = { "link": jsonItem.link, "name": jsonItem.title, "pubDate": jsonItem.pubDate, "score": score};
          let match = NAME_RE.exec(jsonItem.title.replaceAll('.', ' '));
          if (match) Object.assign(item, match.groups);
          return item;
        })};
      }
      function newsnabAjaxURLGenerator(url, config, params) {
        let pageUrl = new URL(url);
        if (params.t) pageUrl.searchParams.set('t', params.t);
        if (params.o) pageUrl.searchParams.set('o', params.o);
        if (params.cat) pageUrl.searchParams.set('cat', params.cat);
        if (params.apikey) pageUrl.searchParams.set('apikey', params.apikey);
        if (!params.size) params.size = 100;
        if (!params.page) params.page = 0;
        pageUrl.searchParams.set('limit', params.size);
        pageUrl.searchParams.set('offset', params.size * params.page);
        return pageUrl;
      }
      var table = new Tabulator("#rss-agg-table", {
        index: "link",
       	columns: [
      	 	{title:"Site", field:"site", visible: false},
      	 	{title:"Episode", field:"episode", visible: false},
      	 	{title:"Title", field:"title", visible: false},
      	 	{title:"Score", field:"score", visible: true},
      	 	{title:"Published", field:"pubDate", visible: false},
      	 	{title:"Name", field:"name", formatter: "link", formatterParams: {labelField: "name", urlField:"link", download: true}},
        ],
        initialFilter:[
          {field:"score", type:">=", value:"0"},
          {field:"title", type:"!=", value:""}
        ],
        initialSort: [
          {column:"score", dir:"asc"},
          {column:"name", dir:"asc"},
          {column:"pubDate", dir:"asc"},
        ],
        headerVisible: false,
        layout: "fitDataStretch",
        layoutColumnsOnNewData: true,
        groupBy: d => `${d.title} (${d.site} ${d.episode})`,
        groupStartOpen: false,
        groupToggleElement: "header",
        // https://tabulator.info/docs/5.5/data#ajax-progressive
        progressiveLoad: "load",        
        // https://tabulator.info/docs/5.5/data#ajax-cors
        ajaxURL: window.localStorage.getItem("nzbUrl"),
        ajaxParams: { 't': 'search', 'o': 'json', 'cat': 6040 },
        ajaxURLGenerator: newsnabAjaxURLGenerator,
        ajaxResponse: newsnabAjaxResponse,
      });
    </script>
  </body>
</html>
