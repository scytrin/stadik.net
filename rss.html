<html>
  <head>
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/listjs/2.3.1/list.min.js"></script>
    <script type='text/javascript'>
      class RSSAgg {
        static DEFAULT_NZB_URL = '?t=search&cat=6000&o=json';
        static DECORS = 'https://cors-anywhere.herokuapp.com/';
        static NAME_RE = /(?<site>\w+)\W(?<episode>[Ee]\d+|(?<year>\d{2,4})(?:\W(?<month>\d{2})\W(?<day>\d{2}))?)\W(?<title>.+)\WXXX/;
        sceneEvals = [["1080p", "HEVC"], ["720p", "HEVC"], ["1080p"], ["720p"]];
        constructor() {
          this.nzbUrl = window.localStorage.getItem("nzbUrl");
          this.gqlUrl = window.localStorage.getItem("gqlUrl");
          this.debug = true;
        }
        #processItem(jsonItem) {
          if (this.debug) console.log(jsonItem);
          let item = {"link": jsonItem.link, "name": jsonItem.title};
          let match = RSSAgg.NAME_RE.exec(jsonItem.title.replaceAll('.', ' '));
          if (match) Object.assign(item, match.groups);
          return item;
        }
        #getPage(pageNum) {
          let pageUrl = new URL(this.nzbUrl);
          pageUrl.searchParams.set('limit', pageUrl.searchParams.get('limit') || 100);
          pageUrl.searchParams.set('offset', pageUrl.searchParams.get('limit') * pageNum);
          pageUrl.searchParams.set('o', 'json');
          return fetch(RSSAgg.DECORS + pageUrl).then(response => response.json())
            .then(json => json.channel.item.map(jsonItem => this.#processItem(jsonItem)));
        }
        consumeFeed(pages) {
          let pageRequests = [...Array(pages || 1).keys()].map(i=>this.#getPage(i));
          return Promise.all(pageRequests).then(all=>all.flat());
        }
        betterScene(sceneA, sceneB) {
          let a = sceneEvals.findIndex(e=>e.all(t=>sceneA.name.includes(t)));
          let b = sceneEvals.findIndex(e=>e.all(t=>sceneB.name.includes(t)));
          if (a > b) return [b, a];
          return [a, b];
        }
      }      
      var app = new RSSAgg();
      var feed = app.consumeFeed();
    </script>
  </head>
  <body>
    <div id='rss_agg'>
      <input id='nzbUrl'  />
      <input class="search" placeholder="Search" />
      <table>
        <tr>
          <td><button class="sort" data-sort="site">Site</button></td>
          <td><button class="sort" data-sort="episode">Occurence</button></td>
          <td><button class="sort" data-sort="title">Title</button></td>
          <td><button class="sort" data-sort="name">Name</button></td>
        </tr>
        <tbody class="list">
          <tr>
            <td class='site'></td>
            <td class='episode'></td>
            <td class='title'></td>
            <td><a href='' class='link name'></a></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div id="example-table"></div>

    <script type='text/javascript'>
      var itemList =  new List('rss_agg', {valueNames: [
        { attr: 'href', name: 'link' },
        'name',
        'site',
        'episode',
        'title',
      ]});

      var table = new Tabulator("#example-table", {
        dataTree: true,
        dataTreeFilter: false,
        dataTreeSort: false,
       	columns:[ //Define Table Columns
      	 	{title:"Site", field:"site", hozAlign:"left"},
      	 	{title:"@", field:"episode", sorter:"date", hozAlign:"center"},
      	 	{title:"Title", field:"title"},
      	 	{title:"Name", field:"name", width: 150},
       	],
      });
      
      feed.then(items => items.forEach(e=>{
        console.log(e);
        itemList.add(e);
      }));
    </script>
  </body>
</html>
